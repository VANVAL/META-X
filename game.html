<html>
<head>
	
	<title>2.3 Colisiones</title>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script type="text/javascript" src="js/three/three.js"></script>
	<script type="text/javascript" src="js/three/MTLLoader.js"></script>
	<script type="text/javascript" src="js/three/OBJLoader.js"></script>
	<script type="text/javascript">

	var scene;
	var camera;
	var renderer;
	var controls;
	var objects = [];
	var clock;
	var deltaTime;	
	var keys = {};

	//objeto para la colision
	var raycaster;
	var objetosConColision =[]; //los objetos que si tenga colision  los agregamos a este arreglo
	//UNA VEZ QUE QUITES EL OBJETO DE LA ESCENA QUITALO DEL ARREGLO TAMBIEN




	var isWorldReady = [ false, false ];
	$(document).ready(function() {

		//inicializando el raycaster
		raycaster =new THREE.Raycaster(); 

		setupScene();


		//creando los rayos a disparar para la colision
		camera.rayos =[
		new THREE.Vector3(1,0,0),
		new THREE.Vector3(-1,0,0),
		new THREE.Vector3(0,0,1),
		new THREE.Vector3(0,0,-1),
		]; //esta disparando en sus 4 puntos cardinales

		loadOBJWithMTL("assets/", "box.obj", "box.mtl", (object) => {
			object.position.z = -30;			

			var box2 = object.clone();
			box2.position.x = 30;

			var box3 = object.clone();
			box3.position.x = - 30;
			var box4 = object.clone();
			box4.position.x = 30;
			box4.position.z = 30;
			var box5 = object.clone();
			box5.position.x = -30;
			box5.position.z = 30;

			var box6 = object.clone();
			box6.position.x = 0;
			box6.position.z = 30;
			

			var box7 = object.clone();
			box7.rotation.y = THREE.Math.degToRad(90);
			box7.position.x = 40
			box7.position.z = 3;
			

			var box8 = object.clone();
			box8.rotation.y = THREE.Math.degToRad(90);
			box8.position.x = -40
			box8.position.z = 3;
			


			scene.add(object);
			scene.add(box2);
			scene.add(box3);
			scene.add(box4);
			scene.add(box5);
			scene.add(box6);
			scene.add(box7);
			scene.add(box8);

			//metiendo nuestro objetos qwue colisionan al arreglo
			objetosConColision.push(object);
			objetosConColision.push(box2);
			objetosConColision.push(box3);
			objetosConColision.push(box4);
			objetosConColision.push(box5);
			objetosConColision.push(box6);
			objetosConColision.push(box7);
			objetosConColision.push(box8);
			

			isWorldReady[0] = true;
		});

		loadOBJWithMTL("assets/", "jetski.obj", "jetski.mtl", (object) => {
			object.position.z = -10;
			object.rotation.x = THREE.Math.degToRad(-90);

			scene.add(object);
			isWorldReady[1] = true;
		});

		render();

		document.addEventListener('keydown', onKeyDown);
		document.addEventListener('keyup', onKeyUp);		
	});

	function loadOBJWithMTL(path, objFile, mtlFile, onLoadCallback) {
		var mtlLoader = new THREE.MTLLoader();
		mtlLoader.setPath(path);
		mtlLoader.load(mtlFile, (materials) => {
			
			var objLoader = new THREE.OBJLoader();
			objLoader.setMaterials(materials);
			objLoader.setPath(path);
			objLoader.load(objFile, (object) => {
				onLoadCallback(object);
			});

		});
	}

	function onKeyDown(event) {
		keys[String.fromCharCode(event.keyCode)] = true;
	}
	function onKeyUp(event) {
		keys[String.fromCharCode(event.keyCode)] = false;
	}

	
	function render() {
		requestAnimationFrame(render);
		deltaTime = clock.getDelta();	

		var yaw = 0;
		var forward = 0;
		if (keys["A"]) {
			yaw = 5;
		} else if (keys["D"]) {
			yaw = -5;
		}
		if (keys["W"]) {
			forward = -20;
		} else if (keys["S"]) {
			forward = 20;
		}

		if (isWorldReady[0] && isWorldReady[1]) {
			
			//EVALUANDO LA COLISION
			//le preguntamos a THREEJS vector por vector, cuales han chocado (lo recorremos con un for)

			for(var i=0; i<camera.rayos.length; i++){

				var rayo= camera.rayos[i];

				raycaster.set(camera.position, rayo);//primer parametro desde donde y el ultimo hacia donde va TODO EN VECTORES

				//DETECTANDO LA COLISION

				//var colision = raycaster.intersectObject(box);//checa colision con un solo objecto, tenemos que duplicarlo para todos los demas objetos :C
				//Existe una variante con objects envez de object y con eso le pasamos el arreglo de objetos con los que queremos que colisione

				//esto es un arreglo tmb
				var colision = raycaster.intersectObjects(objetosConColision,true);//este es el metodo chido uwu
				//el true tambien verigfica colision con los hijos de los modelos, en caso de que no pase por el padre uwu

				//validando que el arreglo tiene un dato(oseae  qeu colisionÃ³)
				if(colision.length>0 && colision[0].distance< 1){
					//debugger;
					console.log("COLISIONANDO!!");

					//SOLUTION
					scene.remove(colision[0].object.parent);
					

					//MY TRIES
					/*for(var i=0; i<colision.length; i++)
					{
						scene.remove( collisions[0].object );
					}*/

					//scene.remove(this.colision[i].object());

				}	

				//NOS DAMOS CUENTA QUE YA MARCA COLISIONES SIN ESTAR CERCA DEL OBJETO PARA ESO LE CAMBIAMOS LA DISTANCIA DEL RAYO

			}


			camera.rotation.y += yaw * deltaTime;
			camera.translateZ(forward * deltaTime);
		}
		
	
		renderer.render(scene, camera);
	}

	function setupScene() {		
		var visibleSize = { width: window.innerWidth, height: window.innerHeight};
		clock = new THREE.Clock();		
		scene = new THREE.Scene();
		camera = new THREE.PerspectiveCamera(75, visibleSize.width / visibleSize.height, 0.1, 100);
		camera.position.z = 2;
		camera.position.y = 5;

		renderer = new THREE.WebGLRenderer( {precision: "mediump" } );
		renderer.setClearColor(new THREE.Color(0, 0, 0));
		renderer.setPixelRatio(visibleSize.width / visibleSize.height);
		renderer.setSize(visibleSize.width/1.22, visibleSize.height/2);

		var ambientLight = new THREE.AmbientLight(new THREE.Color(1, 1, 1), 1.0);
		scene.add(ambientLight);

		var directionalLight = new THREE.DirectionalLight(new THREE.Color(1, 1, 0), 0.4);
		directionalLight.position.set(0, 0, 1);
		scene.add(directionalLight);

		var grid = new THREE.GridHelper(50, 10, 0xffffff, 0xffffff);
		grid.position.y = -1;
		scene.add(grid);

        $("#scene-section").append(renderer.domElement);
        $("#scene-section2").append(renderer.domElement);
        
	}


	</script>
</head>

<body>

    <div id="scene-section"></div>
    <div id="scene-section2"></div>
    <button id="btn_exit" style="float:right">EXIT</button>

</body>
</html>