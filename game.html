<html>

<head>
	<title>META-X</title>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script type="text/javascript" src="js/three/three.js"></script>
	<script type="text/javascript" src="js/three/MTLLoader.js"></script>
	<script type="text/javascript" src="js/three/OBJLoader.js"></script>
	<link rel="stylesheet" type="text/css" media="screen" href="css/main.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="css/game.css" />
	<script type="text/javascript">
		var scene;
		var scene2;
		var camera;
		var camera2;
		var renderer;
		var renderer2;
		var controls;
		var objects = [];
		var clock;
		var clock2;
		var deltaTime;
		var keys = {};

		//TODO:VARIABLE DE PRUEBA
		var naveTest;
		var naveTest2;
		//TODO: END




		//TODO: MODELOS AQUI
		var spaceship1;
		var spaceship2;
		var spaceship3;
		var asteroid;
		var fondo;
		//TODO: TERMINAN MODELOS

		//objeto para la colision
		var raycaster;
		var objetosConColision = []; //los objetos que si tenga colision  los agregamos a este arreglo
		//UNA VEZ QUE QUITES EL OBJETO DE LA ESCENA QUITALO DEL ARREGLO TAMBIEN

		/* var raycaster2;
		var objetosConColision2 = []; */


		var isWorldReady = [false, false];
		$(document).ready(function () {

			//inicializando el raycaster
			raycaster = new THREE.Raycaster();
			//raycaster2 = new THREE.Raycaster();

			setupScene();
			//setupScene2();


			//creando los rayos a disparar para la colision
			camera.rayos = [
				new THREE.Vector3(1, 0, 0),
				new THREE.Vector3(-1, 0, 0),
				new THREE.Vector3(0, 0, 1),
				new THREE.Vector3(0, 0, -1),
			]; //esta disparando en sus 4 puntos cardinales


			//TODO: MODELS
			loadOBJWithMTL("assets/ship1/", "spaceship1Triangles.obj", "spaceship1Triangles.mtl", (spaceship1) =>{
				
				naveTest=spaceship1;
				
				spaceship1.position.x= -100;
				spaceship1.position.z= -30;
				spaceship1.scale.set(2,3,3);

				var spaceship2 = spaceship1.clone();
				naveTest2=spaceship2;

				spaceship1.rotation.y = THREE.Math.degToRad(90);
				spaceship1.rotation.x = THREE.Math.degToRad(270);
							
				spaceship2.rotation.y = THREE.Math.degToRad(90);
				spaceship2.rotation.x = THREE.Math.degToRad(270);
				spaceship2.position.x = -100;
				spaceship2.position.z = 30;
				
				
				scene.add(spaceship1);
				scene.add(spaceship2);


				//objetosConColision.push(spaceship1);
				isWorldReady[0] = true;
			});

			
			loadOBJWithMTL("assets/asteroid/", "AsteroidTriangles.obj", "AsteroidTriangles.mtl", (asteroid) =>{
				
				asteroid.position.x=10;				
				//scene.add(asteroid);
				

				//objetosConColision.push(asteroid);
				isWorldReady[1] = true;
			});

			loadOBJWithMTL("assets/", "cube3.obj", "cube3.mtl", (fondo) =>{
				
				fondo.position.y= -150;
				fondo.rotation.x= THREE.Math.degToRad(90);	
				//fondo.rotation.y= THREE.Math.degToRad(180);
				fondo.scale.set(18,18,1);			
				scene.add(fondo);
				
				//objetosConColision.push(fondo);

				//isWorldReady[5] = true;
			});

			/* loadOBJWithMTL("assets/ship3/", "ship3.obj", "ship3.mtl", (spaceship3) =>{
				
				spaceship3.position.x=20;
				spaceship3.position.z=20;				
				scene.add(spaceship3);
				

				objetosConColision.push(spaceship3);
				isWorldReady[4] = true;
			}); */
		//TODO: MODELS END
			
			render();

			document.addEventListener('keydown', onKeyDown);
			document.addEventListener('keyup', onKeyUp);

			// TODO: BOTON SALIR 
			$("body").on('click', '#btnExit', function () {
				$(location).attr('href', 'mainMenu.html');
			});
			//TODO: TERMINA BOTON SALIR
	
		});

		function loadOBJWithMTL(path, objFile, mtlFile, onLoadCallback) {
			var mtlLoader = new THREE.MTLLoader();
			mtlLoader.setPath(path);
			mtlLoader.load(mtlFile, (materials) => {

				var objLoader = new THREE.OBJLoader();
				objLoader.setMaterials(materials);
				objLoader.setPath(path);
				objLoader.load(objFile, (object) => {
					onLoadCallback(object);
				});
			});
		}

		function onKeyDown(event) {
			keys[String.fromCharCode(event.keyCode)] = true;
		}

		function onKeyUp(event) {
			keys[String.fromCharCode(event.keyCode)] = false;
		}


		function render() {
			requestAnimationFrame(render);
			deltaTime = clock.getDelta();

			var yaw = 0;
			var forward = 0;
			var yaw2 = 0;
			var forward2 = 0;
			//PLAYER 1
			if (keys["A"]) {
				yaw = -40;
				
			} else if (keys["D"]) {
				yaw = 40;
			}
			if (keys["W"]) {
				forward = 40;
			} else if (keys["S"]) {
				forward = -40;
			}
			
			//PLAYER 2 
			 if (keys["J"]) {
				yaw2 = -40;
				
			} else if (keys["L"]) {
				yaw2 = 30;
			}
			if (keys["I"]) {
				forward2 = 40;
			} else if (keys["K"]) {
				forward2 = -40;
			} 

			if (isWorldReady[0] && isWorldReady[1]) {


				//TODO: Colisiones spaceship1
				/* for(var i = 0; i < spaceship1.rayos.length; i++)
				{
					var rayo2= spaceship1.rayos[i];
					raycaster2.set(spaceship1.position, rayo2);

					var colision2 = raycaster2.intersectObjects(objetosConColision, true); 

					if (colision2.length > 0 && colision2[0].distance < 1) {
						//debugger;
						console.log("COLISIONANDO!!");

						//SOLUTION
						scene.remove(colision2[0].object.parent);

					}
				} */
				//TODO: Terminan colisiones spaceship1


				//EVALUANDO LA COLISION
				//le preguntamos a THREEJS vector por vector, cuales han chocado (lo recorremos con un for)

				for (var i = 0; i < camera.rayos.length; i++) {

					var rayo = camera.rayos[i];


					raycaster.set(camera.position, rayo); //primer parametro desde donde y el ultimo hacia donde va TODO EN VECTORES

					//DETECTANDO LA COLISION

					//var colision = raycaster.intersectObject(box);//checa colision con un solo objecto, tenemos que duplicarlo para todos los demas objetos :C
					//Existe una variante con objects envez de object y con eso le pasamos el arreglo de objetos con los que queremos que colisione

					//esto es un arreglo tmb
					var colision = raycaster.intersectObjects(objetosConColision, true); //este es el metodo chido uwu
					//el true tambien verigfica colision con los hijos de los modelos, en caso de que no pase por el padre uwu


					//validando que el arreglo tiene un dato(oseae  qeu colisionÃ³)
					if (colision.length > 0 && colision[0].distance < 1) {
						//debugger;
						console.log("COLISIONANDO!!");

						//SOLUTION
						scene.remove(colision[0].object.parent);



						//MY TRIES
						/*for(var i=0; i<colision.length; i++)
						{
							scene.remove( collisions[0].object );
						}*/

						//scene.remove(this.colision[i].object());

					}

					//NOS DAMOS CUENTA QUE YA MARCA COLISIONES SIN ESTAR CERCA DEL OBJETO PARA ESO LE CAMBIAMOS LA DISTANCIA DEL RAYO

				}
				//naveTest.rotation.y += yaw * deltaTime;
				naveTest.translateY(forward * deltaTime);
				naveTest.translateZ( yaw  * deltaTime);

				naveTest2.translateY(forward2 * deltaTime);
				naveTest2.translateZ( yaw2  * deltaTime);

			}
			renderer.render(scene, camera);

		}

		function setupScene() {
			var visibleSize = {
				width: window.innerWidth,
				height: window.innerHeight
			};
			clock = new THREE.Clock();
			scene = new THREE.Scene();
			camera = new THREE.PerspectiveCamera(90, visibleSize.width / visibleSize.height, 0.1, 300);
			camera.position.z = 0;
			camera.position.y = 80;
			camera.rotation.x = THREE.Math.degToRad(-90);

			renderer = new THREE.WebGLRenderer({
				precision: "mediump"
			});
			renderer.setClearColor(new THREE.Color(0, 0, 0));
			renderer.setPixelRatio(visibleSize.width / visibleSize.height);
			renderer.setSize(visibleSize.width / 1.22, visibleSize.height);
			//renderer.setSize(visibleSize.width/1.22, visibleSize.height/2);

			var ambientLight = new THREE.AmbientLight(new THREE.Color(1, 1, 1), 1.0);
			scene.add(ambientLight);

			var directionalLight = new THREE.DirectionalLight(new THREE.Color(1, 1, 0), 0.4);
			directionalLight.position.set(0, 0, 1);
			scene.add(directionalLight);

			//var grid = new THREE.GridHelper(50, 10, 0xffffff, 0xffffff);
			//grid.position.y = -1;
			//scene.add(grid);

			$("#scene-section").append(renderer.domElement);

		}

	</script>
</head>

<body>
	<!--<audio src="audio/Maintitle.mp3" loop autoplay></audio>-->
	<div id="leftContainerG">
		<div id="canvasP1">
			<div id="scene-section"></div>
		</div>
		<!--<div id="canvasP2">
					<div id="scene-section2"></div>
				</div>-->
	</div>

	<div id="rightContainerG">
		<div id="controlsContainer">
			<div class="playerControls">
				<p>PLAYER 1</p>
				<img src="img/wasd.png" alt="controls">

			</div>
			<div class="playerControls">
				<p>PLAYER 2</p>
				<img src="img/arrowKeys.png" alt="controls">
			</div>
			<div class="playerControls">
				<p>PAUSE</p>
				<img src="img/letter_p.png" alt="">
			</div>

			<button id="btnExit"  class="button" style="width: 100px; top: 20px;">EXIT</button>

		</div>
	</div>
</body>

</html>